// Onno Meeting Storage Schema
// Phase 2-2: 회의 저장 시스템
// Phase 2-3: 개인화 Lv.1
// Phase 3: 나만의 온노 - 개인화 시스템 강화

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ 사용자 (User) ============
model User {
  id          String   @id @default(cuid())
  email       String?  @unique  // Optional for backward compatibility
  name        String?

  // 인증 정보
  passwordHash String?  // 이메일 가입 시
  provider     AuthProvider @default(EMAIL)
  providerId   String?  // OAuth provider의 user ID

  // 프로필
  avatarUrl   String?
  role        UserRole @default(INVESTOR)  // VC/AC 타겟
  company     String?
  jobTitle    String?

  // 개인화 설정
  preferences UserPreferences?

  // 관계
  meetings    Meeting[]
  questionActions QuestionAction[]
  relationships   RelationshipObject[]
  domainLevels    UserDomainLevel[]  // Phase 3: 도메인별 레벨

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum AuthProvider {
  EMAIL
  GOOGLE
  KAKAO
}

enum UserRole {
  INVESTOR      // VC 심사역
  ACCELERATOR   // AC 매니저
  FOUNDER       // 창업자
  OTHER
}

// 사용자 질문 선호도
model UserPreferences {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 질문 카테고리별 선호도 (0.0 ~ 1.0)
  businessModelPref  Float @default(0.5)
  tractionPref       Float @default(0.5)
  teamPref           Float @default(0.5)
  marketPref         Float @default(0.5)
  technologyPref     Float @default(0.5)
  financialsPref     Float @default(0.5)
  risksPref          Float @default(0.5)

  // 말투/톤 선호
  tone               ToneStyle @default(FORMAL)
  includeExplanation Boolean   @default(false)  // 용어 설명 포함 여부

  // 학습 통계
  totalQuestionsSeen Int @default(0)
  totalQuestionsUsed Int @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum ToneStyle {
  FORMAL      // 격식체
  CASUAL      // 비격식체
  DIRECT      // 직접적
}

// 질문 액션 로그 (학습 데이터)
model QuestionAction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId  String?

  // 원본 질문 정보
  originalText String
  category     QuestionCategory?

  // 사용자 액션
  action       QuestionActionType
  modifiedText String?  // 수정해서 사용한 경우

  // 컨텍스트
  meetingId    String?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([category])
  @@index([action])
}

enum QuestionActionType {
  USED           // 그대로 사용
  USED_MODIFIED  // 수정해서 사용
  IGNORED        // 무시
  DISMISSED      // 명시적 거부
}

// ============ 관계 객체 (RelationshipObject) ============
// Onno의 핵심 차별점 - 스타트업/고객/파트너별 카드 관리

model RelationshipObject {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 기본 정보
  name        String   // "A팀", "B사"
  type        RelationshipType @default(STARTUP)
  industry    Industry?
  stage       FundingStage?
  status      RelationshipStatus @default(ACTIVE)

  // 구조화 데이터 (MRR, CAC, LTV 등)
  structuredData Json?   // { "mrr": 50000, "cac": 30, "ltv": 500, ... }

  // 자유 노트
  notes       String?
  tags        String[] // 태그 배열

  // 관계
  meetings    Meeting[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([name])
}

enum RelationshipType {
  STARTUP     // 스타트업
  CLIENT      // 고객사
  PARTNER     // 파트너
  OTHER
}

enum Industry {
  B2B_SAAS
  B2C_APP
  ECOMMERCE
  FINTECH
  HEALTHTECH
  EDTECH
  PROPTECH
  LOGISTICS
  AI_ML
  BIOTECH
  OTHER
}

enum FundingStage {
  PRE_SEED
  SEED
  SERIES_A
  SERIES_B
  SERIES_C_PLUS
  GROWTH
  IPO
  OTHER
}

enum RelationshipStatus {
  ACTIVE      // 활성
  ON_HOLD     // 대기 중
  PASSED      // 패스
  INVESTED    // 투자 완료
  ARCHIVED    // 보관됨
}

// ============ 회의 (Meeting) ============
model Meeting {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])

  // 관계 객체 연결 ⭐ 핵심
  relationshipObjectId String?
  relationshipObject   RelationshipObject? @relation(fields: [relationshipObjectId], references: [id])
  meetingNumber        Int @default(1)  // 이 관계와의 몇 번째 미팅인지

  // 회의 정보
  title       String?
  meetingType MeetingType @default(GENERAL)
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  status      MeetingStatus @default(ACTIVE)

  // 회의 메타데이터
  duration    Int?     // 초 단위
  summary     String?  // AI 생성 요약

  // 관계
  transcripts Transcript[]
  questions   Question[]
  meetingSummary MeetingSummary?  // Phase 3: AI 생성 상세 요약

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([relationshipObjectId])
  @@index([status])
  @@index([startedAt])
}

enum MeetingType {
  INVESTMENT_1ST    // 투자 1차 미팅
  INVESTMENT_2ND    // 투자 2차+ 미팅
  IR                // IR 미팅
  DUE_DILIGENCE     // 실사
  MENTORING         // 멘토링
  GENERAL           // 일반
}

enum MeetingStatus {
  ACTIVE      // 진행 중
  ENDED       // 종료됨
  PROCESSING  // 후처리 중 (화자분리 등)
  COMPLETED   // 완료
}

// 전사 기록 (Transcript)
model Transcript {
  id          String   @id @default(cuid())
  meetingId   String
  meeting     Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // 전사 내용
  text        String
  formattedText String?

  // 화자 정보
  speaker     String?
  speakerRole SpeakerRole?

  // 타이밍
  startTime   Float?   // 회의 시작 기준 초
  endTime     Float?

  // 메타데이터
  provider    String?  // daglo, whisper
  latency     Float?   // STT 처리 시간

  createdAt   DateTime @default(now())

  @@index([meetingId])
  @@index([createdAt])
}

enum SpeakerRole {
  INVESTOR
  FOUNDER
  UNKNOWN
}

// AI 생성 질문 (Question)
model Question {
  id          String   @id @default(cuid())
  meetingId   String
  meeting     Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // 질문 내용
  text        String
  category    QuestionCategory?
  priority    Int      @default(0)  // 높을수록 중요

  // 질문 상태
  isUsed      Boolean  @default(false)  // 사용자가 사용했는지
  isFavorite  Boolean  @default(false)  // 즐겨찾기
  feedback    QuestionFeedback?

  // 맥락
  context     String?  // 질문 생성 맥락 (어떤 발화에서 생성됐는지)

  // Phase 3: 피드백 상세
  feedbackDetails QuestionFeedbackDetail[]

  createdAt   DateTime @default(now())

  @@index([meetingId])
  @@index([category])
  @@index([isUsed])
}

enum QuestionCategory {
  BUSINESS_MODEL
  TRACTION
  TEAM
  MARKET
  TECHNOLOGY
  FINANCIALS
  RISKS
  GENERAL
}

enum QuestionFeedback {
  HELPFUL
  NOT_HELPFUL
  SKIP
}

// ============ Phase 3: 나만의 온노 - 도메인 레벨 시스템 ============

// 사용자 도메인별 레벨 및 XP
model UserDomainLevel {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  domain      DomainType
  level       Int      @default(1)  // 1 ~ 5
  experiencePoints Int @default(0)  // XP

  // 해금된 기능
  unlockedFeatures String[]  // ["past_context", "benchmark", "risk_detection", ...]

  // 페르소나 설정
  persona     PersonaType @default(ANALYST)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, domain])
  @@index([userId])
  @@index([domain])
}

enum DomainType {
  INVESTMENT_SCREENING  // 투자 심사
  MENTORING             // 멘토링
  SALES                 // 세일즈
  PRODUCT_REVIEW        // 제품 리뷰
  TEAM_MEETING          // 팀 1:1
  USER_INTERVIEW        // 사용자 인터뷰
  GENERAL               // 일반
}

enum PersonaType {
  ANALYST     // 분석가 - 숫자/데이터 중심
  BUDDY       // 동료 - 협력적/공감 중심
  GUARDIAN    // 수호자 - 리스크 관리 중심
  VISIONARY   // 비전가 - 기회/미래 중심
}

// 레벨업 히스토리
model LevelHistory {
  id          String   @id @default(cuid())
  userId      String
  domain      DomainType

  oldLevel    Int
  newLevel    Int
  xpAtLevelUp Int

  // 해금된 기능
  newFeatures String[]

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([domain])
}

// 질문 피드백 상세 (학습용)
model QuestionFeedbackDetail {
  id          String   @id @default(cuid())
  userId      String
  questionId  String
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  rating      FeedbackRating
  tags        String[]  // ["timing_good", "too_aggressive", "helpful", ...]
  comment     String?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([questionId])
}

enum FeedbackRating {
  THUMBS_UP
  THUMBS_DOWN
}

// 회의 요약 (AI 생성)
model MeetingSummary {
  id          String   @id @default(cuid())
  meetingId   String   @unique
  meeting     Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // 요약 내용
  summary     String   // 전체 요약
  keyPoints   String[] // 핵심 포인트
  decisions   String[] // 결정 사항
  actionItems String[] // 후속 조치

  // 중요 질문들
  keyQuestions String[] // 회의 중 중요 질문
  missedQuestions String[] // 놓친 질문 (확인 안 된 것)

  // 관계 객체 데이터 업데이트 제안
  suggestedDataUpdates Json?  // { "mrr": 60000, "cac": 25 } 등

  // 다음 회의 아젠다 제안
  nextMeetingAgenda String[]

  // 메타데이터
  generatedAt DateTime @default(now())
  model       String?  // 생성에 사용된 AI 모델

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}